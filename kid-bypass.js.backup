// ═══════════════════════════════════════════════════════
// k-ID Bypass — Working Implementation
// Based on: kibty.town & Dziurwa14
// Full verification via QR code scanning
// ═══════════════════════════════════════════════════════

var KIDBypass = (function(){
  'use strict';

  var API_ENDPOINT = 'https://age-verifier.kibty.town/api/verify';
  var verificationInProgress = false;

  // ─── QR Code Scanner (jsQR integration) ───
  async function decodeQRFromImage(file){
    return new Promise(function(resolve, reject){
      var reader = new FileReader();
      reader.onload = function(e){
        var img = new Image();
        img.onload = function(){
          var canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          var ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          
          // Simple QR detection (fallback if jsQR not available)
          if(typeof jsQR !== 'undefined'){
            var result = jsQR(imageData.data, imageData.width, imageData.height);
            if(result){
              resolve(result.data);
            } else {
              reject('No QR code found in image');
            }
          } else {
            reject('QR scanner library not loaded');
          }
        };
        img.onerror = function(){reject('Failed to load image')};
        img.src = e.target.result;
      };
      reader.onerror = function(){reject('Failed to read file')};
      reader.readAsDataURL(file);
    });
  }

  // ─── Verify via API ───
  async function verifyWithQRCode(qrCodeUrl){
    if(verificationInProgress){
      throw new Error('Verification already in progress');
    }
    
    verificationInProgress = true;
    
    try{
      var response = await fetch(API_ENDPOINT, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          type: 'qr_link',
          identifier: qrCodeUrl
        })
      });
      
      if(!response.ok){
        var errorText = await response.text();
        throw new Error('Verification failed: ' + errorText);
      }
      
      var result = await response.json();
      verificationInProgress = false;
      return result;
    } catch(err){
      verificationInProgress = false;
      throw err;
    }
  }

  // ─── Public API ───
  return {
    // Verify using QR code URL
    verify: async function(qrCodeUrl){
      if(!qrCodeUrl || typeof qrCodeUrl !== 'string'){
        throw new Error('Invalid QR code URL');
      }
      return await verifyWithQRCode(qrCodeUrl);
    },
    
    // Verify using QR code image file
    verifyFromImage: async function(imageFile){
      if(!imageFile || !(imageFile instanceof File)){
        throw new Error('Invalid image file');
      }
      var qrCodeUrl = await decodeQRFromImage(imageFile);
      return await verifyWithQRCode(qrCodeUrl);
    },
    
    // Check if verification is in progress
    isVerifying: function(){
      return verificationInProgress;
    },
    
    // Get API endpoint (for debugging)
    getEndpoint: function(){
      return API_ENDPOINT;
    }
  };
})();
